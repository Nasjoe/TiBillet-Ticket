{% load static %}
<form
    id="loginForm"
    hx-post="/connexion/" hx-target="body"
    hx-swap="innerHTML" novalidate 
    hx-on:htmx:before-request="validateLoginEmail(event)"
    hx-on:htmx:after-request="closePanel('#loginPanel', 400)">
    {% csrf_token %}
    <h4>Avec un email</h4>
    <div class="form-floating mb-3">
        <input type="email" class="form-control" id="loginEmail" placeholder="mon@email.fr" required>
        <label for="loginEmail">Mon e-mail</label>
        <p>Pas besoin de mot de passe, un e-mail sera envoyé pour validation.</p>
        <button type="submit" class="btn btn-primary d-block w-100">Valider</button>
    </div>
    <h4 class="mt-5">
        Avec mon compte
        <img src="{% static '/mvt_htmx/images/communecterLogo_31x28.png' %}" class="communecter-logo"
            alt="logo communecter">
        Communecter
    </h4>
    <div class="form-floating mb-3">
        <a href="." onclick="location.href = '/api/user/requestoauth/';" class="btn btn-primary d-block">
            Valider
        </a>
    </div>
</form>

<script>
    function validateLoginEmail(evt) {
        // const error = 0
        const input = document.querySelector('#loginEmail')
        let value = input.value
        const re = /[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,4}$/
        if (value.match(re) === null) {
            evt.preventDefault()
		    evt.stopPropagation()
            // input en mode invalid
            input.parentNode.classList.remove('is-valid')
            input.parentNode.classList.add('is-invalid')
            // focus le input confirme email
            input.focus()
        } else {
            input.parentNode.classList.remove('is-invalid')
            input.parentNode.classList.add('is-valid')
        }
    }

    function closePanel(id, delay) {
        const element = document.querySelector(id)
        const panel = bootstrap.Offcanvas.getInstance(element)

         // effacer le modal login une fois la requête finie
        window.setTimeout(() => { panel.hide() }, delay)
    }

</script>
